@page "/dynamic-column-demo"
@using QuickGridTest01.DynamicColumns
@using Microsoft.AspNetCore.Components.QuickGrid
@using System.Linq

<PageTitle>Dynamic Column Demo</PageTitle>

<h3>Dynamic Column Demonstration</h3>

<div class="demo-container">
    <div class="demo-section">
        <h4>1. Basic Dynamic Columns</h4>
        <p>Simple property access using PropertyPath parameter</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Id" Title="ID" EnableDiagnostics="true" DiagnosticsId="Sec1" />
            <DynamicColumn PropertyPath="Name" Title="Employee Name" EnableDiagnostics="true" DiagnosticsId="Sec1" LogCells="true" MaxCellLogs="30" />
            <DynamicColumn PropertyPath="Email" Title="Email Address" EnableDiagnostics="true" DiagnosticsId="Sec1" />
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>2. Nested Property Access</h4>
        <p>Access nested properties with dot notation</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Name" Title="Name" EnableDiagnostics="true" DiagnosticsId="Sec2" />
            <DynamicColumn PropertyPath="Address.City" Title="City" EnableDiagnostics="true" DiagnosticsId="Sec2" />
            <DynamicColumn PropertyPath="Address.State" Title="State" EnableDiagnostics="true" DiagnosticsId="Sec2" />
            <DynamicColumn PropertyPath="Address.Country.Name" Title="Country" EnableDiagnostics="true" DiagnosticsId="Sec2" />
            <DynamicColumn PropertyPath="Department.Name" Title="Department" EnableDiagnostics="true" DiagnosticsId="Sec2" />
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>3. Formatted Values</h4>
        <p>Apply formatting to numeric and date values</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Name" Title="Name" EnableDiagnostics="true" DiagnosticsId="Sec3" />
            <DynamicColumn PropertyPath="Salary" Title="Salary" Format="C0" EnableDiagnostics="true" DiagnosticsId="Sec3" />
            <DynamicColumn PropertyPath="HireDate" Title="Hire Date" Format="d" EnableDiagnostics="true" DiagnosticsId="Sec3" />
            <DynamicColumn PropertyPath="Department.Budget" Title="Dept Budget" Format="C0" EnableDiagnostics="true" DiagnosticsId="Sec3" />
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>4. Deep Nesting (3+ Levels)</h4>
        <p>Navigate multiple levels: Department ? Region ? Timezone</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Name" Title="Employee" EnableDiagnostics="true" DiagnosticsId="Sec4" />
            <DynamicColumn PropertyPath="Department.Region.Name" Title="Region" EnableDiagnostics="true" DiagnosticsId="Sec4" />
            <DynamicColumn PropertyPath="Department.Region.Timezone" Title="Timezone" EnableDiagnostics="true" DiagnosticsId="Sec4" />
            <DynamicColumn PropertyPath="Manager.Name" Title="Manager" EnableDiagnostics="true" DiagnosticsId="Sec4" />
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>5. Custom Formatters</h4>
        <p>Apply custom formatting logic</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Name" Title="Name" EnableDiagnostics="true" DiagnosticsId="Sec5" />
            <DynamicColumn PropertyPath="Salary" 
                          Title="Salary Range" 
                          CustomFormatter="@FormatSalaryRange" EnableDiagnostics="true" DiagnosticsId="Sec5" LogCells="true" MaxCellLogs="25" />
            <DynamicColumn PropertyPath="HireDate" 
                          Title="Tenure" 
                          CustomFormatter="@FormatTenure" EnableDiagnostics="true" DiagnosticsId="Sec5" />
            <DynamicColumn PropertyPath="Address.City" 
                          Title="Location" 
                          CustomFormatter="@FormatLocation" EnableDiagnostics="true" DiagnosticsId="Sec5" />
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>6. Report Builder (Runtime Column Selection)</h4>
        <p>User-configurable columns from metadata</p>
        
        <div class="field-selector mb-3">
            <h5>Select Fields:</h5>
            @foreach (var field in AvailableFields)
            {
                <div class="form-check form-check-inline">
                    <input type="checkbox" 
                           class="form-check-input" 
                           id="field-@field.PropertyPath"
                           checked="@IsFieldSelected(field)"
                           @onchange="@(e => ToggleField(field))" />
                    <label class="form-check-label" for="field-@field.PropertyPath">
                        @field.DisplayName
                    </label>
                </div>
            }
        </div>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            @foreach (var field in SelectedFields)
            {
                <DynamicColumn PropertyPath="@field.PropertyPath"
                              Title="@field.DisplayName"
                              Format="@field.Format" EnableDiagnostics="true" DiagnosticsId="Sec6" />
            }
        </QuickGrid>
    </div>

    <div class="demo-section">
        <h4>7. Sortable Columns</h4>
        <p>Dynamic columns automatically support sorting</p>
        
        <QuickGrid Items="@employees" Class="table table-striped" Virtualize="false">
            <DynamicColumn PropertyPath="Id" Title="ID" EnableDiagnostics="true" DiagnosticsId="Sec7" />
            <DynamicColumn PropertyPath="Name" Title="Name" EnableDiagnostics="true" DiagnosticsId="Sec7" />
            <DynamicColumn PropertyPath="Salary" Title="Salary" Format="C0" EnableDiagnostics="true" DiagnosticsId="Sec7" />
            <DynamicColumn PropertyPath="Address.City" Title="City" EnableDiagnostics="true" DiagnosticsId="Sec7" />
            <DynamicColumn PropertyPath="Department.Name" Title="Department" EnableDiagnostics="true" DiagnosticsId="Sec7" />
        </QuickGrid>
    </div>
</div>

<style>
    .demo-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .demo-section {
        margin-bottom: 3rem;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .demo-section h4 {
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
    
    .demo-section p {
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .field-selector {
        padding: 1rem;
        background-color: white;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }
    
    .field-selector h5 {
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    
    .table {
        background-color: white;
    }
</style>

@code {
    private IQueryable<Employee> employees = null!;
    private List<FieldMetadata> AvailableFields = new();
    private List<FieldMetadata> SelectedFields = new();

    protected override void OnInitialized()
    {
        employees = EmployeeDataGenerator.Generate(25).AsQueryable();
        AvailableFields = EmployeeDataGenerator.GetAvailableFields();
        SelectedFields = AvailableFields.Take(4).ToList();
    }

    private bool IsFieldSelected(FieldMetadata field) => 
        SelectedFields.Contains(field);

    private void ToggleField(FieldMetadata field)
    {
        if (IsFieldSelected(field))
        {
            SelectedFields.Remove(field);
        }
        else
        {
            SelectedFields.Add(field);
        }
    }

    private string FormatSalaryRange(object? value)
    {
        if (value is decimal salary)
        {
            if (salary < 70000m) return "?? Entry Level";
            if (salary < 100000m) return "???? Mid Level";
            if (salary < 130000m) return "?????? Senior Level";
            return "???????? Executive";
        }
        return string.Empty;
    }

    private string FormatTenure(object? value)
    {
        if (value is DateTime hireDate)
        {
            var years = (DateTime.Today - hireDate).Days / 365;
            if (years == 0) return "New Hire";
            if (years == 1) return "1 year";
            return $"{years} years";
        }
        return string.Empty;
    }

    private string FormatLocation(object? value) => value is null ? string.Empty : $"?? {value}";
}
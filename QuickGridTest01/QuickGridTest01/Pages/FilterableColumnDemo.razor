@page "/filterable-column-demo"
@using Microsoft.AspNetCore.Components.QuickGrid
@using QuickGridTest01.Filterable

<PageTitle>Filterable Column Demo</PageTitle>

<div class="demo-container">
    <h1>Filterable Columns – Two Approaches</h1>
    <p class="intro-text">
        Reusable column-centric filtering vs a simple manual filter bar. Both are presented with a consistent, conservative layout.
    </p>

    <div class="demo-description" style="margin:1.5rem 0; padding:1rem 1.25rem; background:#f7fafc; border-left:4px solid #3182ce; border-radius:4px; line-height:1.55; font-size:0.93rem;">
        <h3 style="margin-top:0; margin-bottom:0.75rem; font-size:1.25rem; color:#2c5282;">Filtering Design Comparison</h3>
        <p><strong>Reusable (Section A):</strong> Each <code>FilterableColumn&lt;TItem,TValue&gt;</code> owns operator list, parsing, active state and sort expression; <code>FilterableGrid</code> composes active filters.</p>
        <p><strong>Ad Hoc (Section B):</strong> A single filter bar builds a LINQ query directly—simple but duplicative across pages.</p>
        <p><strong>Operators:</strong> Strings use case-insensitive contains; numeric/date operators build typed predicates.</p>
    </div>

    <!-- SECTION A: Reusable Column-Centric Filtering (uses markup from Demo02) -->
    <section class="demo-section">
        <h2>Section A: Reusable Column-Centric Filtering</h2>
        <p class="section-description">Inline toolbar renders operator + value input per column. Filters apply automatically while typing.</p>

        <div class="demo-section">
            <h4>Employees</h4>

            <div class="filter-toolbar">
                @if (_employeeGrid is not null && _employeeGrid.Columns?.Count > 0)
                {
                    foreach (var col in _employeeGrid.Columns)
                    {
                        <div class="ft-item @(col.HasActiveFilter ? "active" : "")">
                            @col.BuildFilterToolbar
                        </div>
                    }
                    <div class="ft-actions">
                        <button class="btn btn-sm btn-secondary" @onclick="ClearEmployeeFilters">Clear All</button>
                    </div>
                }
            </div>

            <FilterableGrid TGridItem="Employee" Items="@Employees" Class="table table-striped" @ref="_employeeGrid">
                <FilterableColumn TGridItem="Employee" TValue="int" Property="@(e => e.Id)" Title="ID" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.FirstName)" Title="First Name" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.LastName)" Title="Last Name" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Department)" Title="Department" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Email)" Title="Email" />
                <FilterableColumn TGridItem="Employee" TValue="int" Property="@(e => e.Salary)" Title="Salary" Format="C0" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="DateTime" Property="@(e => e.HireDate)" Title="Hire Date" Format="yyyy-MM-dd" Sortable="true" />
                <FilterableColumn TGridItem="Employee" TValue="bool" Property="@(e => e.IsActive)" Title="Active" />
            </FilterableGrid>
        </div>

        <div class="demo-section">
            <h4>Products</h4>

            <div class="filter-toolbar">
                @if (_productGrid is not null && _productGrid.Columns?.Count > 0)
                {
                    foreach (var col in _productGrid.Columns)
                    {
                        <div class="ft-item @(col.HasActiveFilter ? "active" : "")">
                            @col.BuildFilterToolbar
                        </div>
                    }
                    <div class="ft-actions">
                        <button class="btn btn-sm btn-secondary" @onclick="ClearProductFilters">Clear All</button>
                    </div>
                }
            </div>

            <FilterableGrid TGridItem="Product" Items="@Products" Class="table table-striped" @ref="_productGrid">
                <FilterableColumn TGridItem="Product" TValue="int" Property="@(p => p.Id)" Title="ID" Sortable="true" />
                <FilterableColumn TGridItem="Product" TValue="string" Property="@(p => p.Name)" Title="Product" Sortable="true" />
                <FilterableColumn TGridItem="Product" TValue="string" Property="@(p => p.Category)" Title="Category" Sortable="true" />
                <FilterableColumn TGridItem="Product" TValue="decimal" Property="@(p => p.Price)" Title="Price" Format="C2" Sortable="true" />
                <FilterableColumn TGridItem="Product" TValue="int" Property="@(p => p.Stock)" Title="Stock" Sortable="true" />
                <FilterableColumn TGridItem="Product" TValue="double" Property="@(p => p.Rating)" Title="Rating" />
            </FilterableGrid>
        </div>
    </section>

    <!-- SECTION B: Ad Hoc Filtering -->
    <section class="demo-section">
        <h2>Section B: Manual Ad Hoc Filtering</h2>
        <p class="section-description">Central filter bar composes LINQ directly. Filters apply while typing.</p>

        <div class="filter-bar">
            <div class="filter-item">
                <label>First Name</label>
                <select @bind="_adHocFirstNameOperator" class="operator-select">
                    @foreach (var op in _stringOps) { <option value="@op.Name">@op.Symbol @op.Name</option> }
                </select>
                <input type="text" @bind="_adHocFirstName" @bind:event="oninput" placeholder="Value..." class="filter-input" />
            </div>
            <div class="filter-item">
                <label>Department</label>
                <select @bind="_adHocDepartmentOperator" class="operator-select">
                    @foreach (var op in _stringOps) { <option value="@op.Name">@op.Symbol @op.Name</option> }
                </select>
                <input type="text" @bind="_adHocDepartment" @bind:event="oninput" placeholder="Value..." class="filter-input" />
            </div>
            <div class="filter-item">
                <label>Salary</label>
                <select @bind="_adHocSalaryOperator" class="operator-select">
                    @foreach (var op in _numericOps) { <option value="@op.Name">@op.Symbol @op.Name</option> }
                </select>
                <input type="number" @bind="_adHocSalaryValue" @bind:event="oninput" class="filter-input" placeholder="Amount..." />
            </div>
            <div class="filter-item">
                <label>Active</label>
                <select disabled class="operator-select"><option>= Is</option></select>
                <select @bind="_adHocActive" class="filter-input">
                    <option value="">All</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <button class="btn-clear-all" @onclick="ClearAdHocEmployeeFilters">Clear</button>
        </div>

        <div class="results-info">Showing @FilteredEmployeesAdHoc.Count() of @Employees.Count() employees</div>

        <QuickGrid Items="@FilteredEmployeesAdHoc" Class="demo-grid">
            <PropertyColumn Property="@(e => e.Id)" Title="ID" />
            <PropertyColumn Property="@(e => e.FirstName)" Title="First Name" Sortable="true" />
            <PropertyColumn Property="@(e => e.LastName)" Title="Last Name" Sortable="true" />
            <PropertyColumn Property="@(e => e.Department)" Title="Department" Sortable="true" />
            <PropertyColumn Property="@(e => e.Email)" Title="Email" />
            <PropertyColumn Property="@(e => e.Salary)" Title="Salary" Format="C0" Sortable="true" />
            <PropertyColumn Property="@(e => e.HireDate)" Title="Hire Date" Format="yyyy-MM-dd" Sortable="true" />
            <TemplateColumn Title="Status">
                <span class="status-badge status-@(context.IsActive ? "active" : "inactive")">@(context.IsActive ? "Active" : "Inactive")</span>
            </TemplateColumn>
        </QuickGrid>
    </section>
</div>

<style>
.demo-container { max-width:1400px; margin:0 auto; padding:2rem; }
.intro-text { color:#6c757d; font-size:1rem; margin-bottom:1.5rem; }
.demo-section { margin-bottom:2rem; background:#fff; border-radius:8px; padding:1.5rem; box-shadow:0 2px 8px rgba(0,0,0,.06); }
.demo-section h2 { color:#34495e; margin-bottom:.75rem; font-size:1.5rem; font-weight:600; border-bottom:3px solid #3498db; padding-bottom:.5rem; }
.section-description { color:#6c757d; margin-bottom:1rem; font-size:.975rem; }
.filter-toolbar { display:flex; flex-wrap:wrap; gap:.75rem; margin-bottom:.75rem; align-items:flex-end; }
.filter-toolbar .ft-item { display:flex; align-items:flex-end; gap:.5rem; }
.ft-inline { display:flex; gap:.5rem; align-items:flex-end; }
.ft-label { font-weight:600; font-size:.8rem; }
.ft-operator, .filter-value { padding:.3rem .4rem; font-size:.8rem; border:1px solid #ced4da; border-radius:.25rem; }
.ft-actions { margin-left:auto; display:flex; gap:.5rem; }
.filter-bar { display:flex; flex-wrap:wrap; gap:.75rem; margin-bottom:.75rem; align-items:flex-end; }
.filter-item { display:flex; flex-direction:column; }
.filter-item label { font-size:.7rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; margin-bottom:.25rem; }
.operator-select, .filter-input { padding:.35rem .5rem; font-size:.8rem; border:1px solid #ced4da; border-radius:.25rem; background:#fff; }
.btn-clear-all, .btn.btn-sm { padding:.4rem .85rem; font-size:.75rem; font-weight:600; letter-spacing:.5px; }
.btn-clear-all { background:#6c757d; color:#fff; border:1px solid #6c757d; }
.results-info { background:#e7f3ff; padding:.5rem .75rem; border-left:4px solid #0d6efd; font-size:.75rem; margin-bottom:.6rem; }
.status-badge { display:inline-block; padding:.25rem .6rem; border-radius:12px; font-size:.65rem; font-weight:600; letter-spacing:.5px; }
.status-active { background:#d4edda; color:#155724; }
.status-inactive { background:#f8d7da; color:#721c24; }
</style>

@code {
    // Shared data
    private IQueryable<Employee> Employees = default!;
    private IQueryable<Product> Products = default!;

    // Section A grid refs (matching Demo02)
    private FilterableGrid<Employee>? _employeeGrid;
    private FilterableGrid<Product>? _productGrid;

    // Ad hoc state (Section B)
    private List<IFilterOperator<string>> _stringOps = new();
    private List<IFilterOperator<int>> _numericOps = new();
    private string _adHocFirstNameOperator = "Contains";
    private string _adHocDepartmentOperator = "Contains";
    private string _adHocSalaryOperator = "Greater Than or Equal";
    private string? _adHocFirstName;
    private string? _adHocDepartment;
    private int? _adHocSalaryValue;
    private string? _adHocActive;

    // Rerender once after first render so Demo02-style toolbars appear before grid
    private bool _rerenderPending;

    private IQueryable<Employee> FilteredEmployeesAdHoc => BuildAdHocEmployeeQuery();

    protected override void OnInitialized()
    {
        Employees = new List<Employee>
        {
            new() { Id = 1, FirstName = "John", LastName = "Smith", Department = "Engineering", Email = "john.smith@company.com", Salary = 95000, HireDate = new DateTime(2020,3,15), IsActive = true },
            new() { Id = 2, FirstName = "Sarah", LastName = "Johnson", Department = "Marketing", Email = "sarah.j@company.com", Salary = 78000, HireDate = new DateTime(2021,7,22), IsActive = true },
            new() { Id = 3, FirstName = "Michael", LastName = "Brown", Department = "Engineering", Email = "m.brown@company.com", Salary = 103000, HireDate = new DateTime(2019,1,10), IsActive = true },
            new() { Id = 4, FirstName = "Emily", LastName = "Davis", Department = "HR", Email = "emily.davis@company.com", Salary = 72000, HireDate = new DateTime(2022,4,5), IsActive = false },
            new() { Id = 5, FirstName = "David", LastName = "Wilson", Department = "Sales", Email = "d.wilson@company.com", Salary = 85000, HireDate = new DateTime(2020,11,30), IsActive = true },
            new() { Id = 6, FirstName = "Jennifer", LastName = "Martinez", Department = "Engineering", Email = "j.martinez@company.com", Salary = 98000, HireDate = new DateTime(2021,2,14), IsActive = true },
            new() { Id = 7, FirstName = "Robert", LastName = "Garcia", Department = "Finance", Email = "robert.g@company.com", Salary = 91000, HireDate = new DateTime(2018,9,8), IsActive = true },
            new() { Id = 8, FirstName = "Lisa", LastName = "Anderson", Department = "Marketing", Email = "lisa.a@company.com", Salary = 76000, HireDate = new DateTime(2023,1,20), IsActive = true },
            new() { Id = 9, FirstName = "James", LastName = "Taylor", Department = "Sales", Email = "james.t@company.com", Salary = 83000, HireDate = new DateTime(2019,6,12), IsActive = false },
            new() { Id = 10, FirstName = "Amanda", LastName = "White", Department = "Engineering", Email = "amanda.w@company.com", Salary = 105000, HireDate = new DateTime(2017,3,25), IsActive = true }
        }.AsQueryable();

        Products = new List<Product>
        {
            new() { Id = 1, Name = "Laptop Pro", Category = "Electronics", Price = 1299.99m, Stock = 45, Rating = 4.5 },
            new() { Id = 2, Name = "Office Chair", Category = "Furniture", Price = 399.99m, Stock = 23, Rating = 4.2 },
            new() { Id = 3, Name = "Wireless Mouse", Category = "Electronics", Price = 49.99m, Stock = 150, Rating = 4.7 },
            new() { Id = 4, Name = "Desk Lamp", Category = "Furniture", Price = 79.99m, Stock = 0, Rating = 4.0 },
            new() { Id = 5, Name = "USB-C Hub", Category = "Electronics", Price = 89.99m, Stock = 67, Rating = 4.6 },
            new() { Id = 6, Name = "Monitor Stand", Category = "Furniture", Price = 149.99m, Stock = 31, Rating = 4.3 },
            new() { Id = 7, Name = "Mechanical Keyboard", Category = "Electronics", Price = 179.99m, Stock = 58, Rating = 4.8 }
        }.AsQueryable();

        _stringOps = new()
        {
            new StringContainsOperator(),
            new StringEqualsOperator(),
            new StringStartsWithOperator(),
            new StringEndsWithOperator()
        };

        _numericOps = new()
        {
            new NumericEqualsOperator<int>(),
            new NumericNotEqualsOperator<int>(),
            new NumericGreaterThanOperator<int>(),
            new NumericGreaterThanOrEqualOperator<int>(),
            new NumericLessThanOperator<int>(),
            new NumericLessThanOrEqualOperator<int>()
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_rerenderPending)
        {
            _rerenderPending = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    // Section A clear methods
    private Task ClearEmployeeFilters() => _employeeGrid?.ClearAllFiltersAsync() ?? Task.CompletedTask;
    private Task ClearProductFilters() => _productGrid?.ClearAllFiltersAsync() ?? Task.CompletedTask;

    // Ad hoc filtering
    private IQueryable<Employee> BuildAdHocEmployeeQuery()
    {
        var q = Employees;
        if (!string.IsNullOrWhiteSpace(_adHocFirstName))
        {
            var op = _stringOps.First(o => o.Name == _adHocFirstNameOperator);
            q = op.Apply(q, e => e.FirstName, _adHocFirstName);
        }
        if (!string.IsNullOrWhiteSpace(_adHocDepartment))
        {
            var op = _stringOps.First(o => o.Name == _adHocDepartmentOperator);
            q = op.Apply(q, e => e.Department, _adHocDepartment);
        }
        if (_adHocSalaryValue.HasValue)
        {
            var op = _numericOps.First(o => o.Name == _adHocSalaryOperator);
            q = op.Apply(q, e => e.Salary, _adHocSalaryValue.Value);
        }
        if (!string.IsNullOrWhiteSpace(_adHocActive))
        {
            var isActive = bool.Parse(_adHocActive);
            q = q.Where(e => e.IsActive == isActive);
        }
        return q;
    }

    private void ClearAdHocEmployeeFilters()
    {
        _adHocFirstName = null;
        _adHocDepartment = null;
        _adHocSalaryValue = null;
        _adHocActive = null;
        _adHocSalaryOperator = "Greater Than or Equal";
        StateHasChanged();
    }

    // Models
    public class Employee
    {
        public int Id { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public int Salary { get; set; }
        public DateTime HireDate { get; set; }
        public bool IsActive { get; set; }
    }
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public double Rating { get; set; }
    }
}

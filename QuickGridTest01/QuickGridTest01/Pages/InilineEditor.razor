@page "/inline"
@using Microsoft.AspNetCore.Components.QuickGrid
@using System.ComponentModel.DataAnnotations
@using System.Linq
@implements IDisposable

<PageTitle>Products with Auto-Save</PageTitle>

<div class="demo-container">
    <h1>Inline Editing (Ad Hoc)</h1>
    <p class="intro-text">Direct template-driven inline editing with per-cell <code>EditForm</code> and auto-save. This page retains the raw approach for comparison.</p>

    <div class="demo-description" style="margin:1.5rem 0; padding:1rem 1.25rem; background:#f7fafc; border-left:4px solid #3182ce; border-radius:4px; line-height:1.55; font-size:0.95rem;">
        <h3 style="margin-top:0; margin-bottom:0.75rem; font-size:1.25rem; color:#2c5282;">Ad‑Hoc Inline Editing Approach</h3>
        <p><strong>What this page shows:</strong> A template‑driven inline editing pattern for <code>QuickGrid</code> where each editable cell embeds an <code>EditForm</code>, validators, and an input component. Auto‑save logic (debounced timer) is implemented in the page.</p>
        <p><strong>Motivation for a reusable column:</strong> Reduces duplication, improves UX consistency, and centralizes validation and commit logic.</p>
    </div>

    <section class="demo-section">
        <h2>Product Management (Auto-Save)</h2>

        @if (hasUnsavedChanges)
        {
            <div class="alert alert-info">
                Unsaved changes detected. Will auto-save in @secondsUntilSave seconds...
            </div>
        }
        else if (lastSaveTime.HasValue)
        {
            <div class="alert alert-success">
                Last saved at @lastSaveTime.Value.ToString("HH:mm:ss")
            </div>
        }

        <QuickGrid Items="@products.AsQueryable()" Class="demo-grid">
            <PropertyColumn Property="@(p => p.Id)" Title="Id" Sortable="true" />

            <TemplateColumn Title="Name" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputText @bind-Value="row.Name" 
                               @oninput="@((e) => OnFieldChanged(row, e.Value?.ToString()))" 
                               class="form-control form-control-sm seamless-input" />
                    <ValidationMessage For="@(() => row.Name)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Price" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputNumber @bind-Value="row.Price" 
                                 @oninput="@((e) => OnFieldChanged(row, e.Value))" 
                                 class="form-control form-control-sm seamless-input" />
                    <ValidationMessage For="@(() => row.Price)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Stock" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputNumber @bind-Value="row.Stock" 
                                 @oninput="@((e) => OnFieldChanged(row, e.Value))" 
                                 class="form-control form-control-sm seamless-input" />
                    <ValidationMessage For="@(() => row.Stock)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Location" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputSelect @bind-Value="row.Location" 
                                 @bind-Value:after="@(() => OnFieldChanged(row, row.Location))" 
                                 class="form-select form-select-sm seamless-input">
                        <option value="LA">LA</option>
                        <option value="NYC">NYC</option>
                        <option value="Wash DC">Wash DC</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => row.Location)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="In Stock" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputCheckbox @bind-Value="row.IsInStock" 
                                   @bind-Value:after="@(() => OnFieldChanged(row, row.IsInStock))" 
                                   class="form-check-input seamless-checkbox" />
                    <ValidationMessage For="@(() => row.IsInStock)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Release Date" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputDate @bind-Value="row.ReleaseDate" 
                               @bind-Value:after="@(() => OnFieldChanged(row, row.ReleaseDate))" 
                               class="form-control form-control-sm seamless-input" />
                    <ValidationMessage For="@(() => row.ReleaseDate)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Priority" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputRadioGroup @bind-Value="row.Priority" 
                                     @bind-Value:after="@(() => OnFieldChanged(row, row.Priority))" 
                                     class="d-flex gap-2">
                        <label class="form-check-label">
                            <InputRadio Value="Priority.Low" class="form-check-input" /> Low
                        </label>
                        <label class="form-check-label">
                            <InputRadio Value="Priority.Medium" class="form-check-input" /> Med
                        </label>
                        <label class="form-check-label">
                            <InputRadio Value="Priority.High" class="form-check-input" /> High
                        </label>
                    </InputRadioGroup>
                    <ValidationMessage For="@(() => row.Priority)" />
                </EditForm>
            </TemplateColumn>

            <TemplateColumn Title="Description" Context="row">
                <EditForm Model="row" class="d-inline">
                    <DataAnnotationsValidator />
                    <InputTextArea @bind-Value="row.Description" 
                                   @oninput="@((e) => OnFieldChanged(row, e.Value?.ToString()))" 
                                   class="form-control form-control-sm seamless-input" 
                                   rows="2" />
                    <ValidationMessage For="@(() => row.Description)" />
                </EditForm>
            </TemplateColumn>
        </QuickGrid>
    </section>
</div>

<style>
    .seamless-input { border: 1px solid transparent; background-color: transparent; transition: all 0.2s ease-in-out; box-shadow: none; outline: none !important; }
    .seamless-input:hover { border-color: #dee2e6; background-color: #f8f9fa; }
    .seamless-input:focus { border-color: #dee2e6 !important; background-color: #f8f9fa; box-shadow: none !important; outline: none !important; }
    .seamless-input.valid, .seamless-input.is-valid, .seamless-input:valid { border: 1px solid transparent !important; background-color: transparent !important; box-shadow: none !important; outline: none !important; }
    .seamless-input.valid:hover, .seamless-input.is-valid:hover, .seamless-input:valid:hover { border-color: #dee2e6 !important; background-color: #f8f9fa !important; }
    .seamless-input.valid:focus, .seamless-input.is-valid:focus, .seamless-input:valid:focus { border-color: #dee2e6 !important; background-color: #f8f9fa !important; box-shadow: none !important; outline: none !important; }
    .seamless-input.valid.modified, .seamless-input.modified.valid { outline: none !important; border: 1px solid transparent !important; background-color: transparent !important; }
    .seamless-input.valid.modified:hover, .seamless-input.modified.valid:hover { border-color: #dee2e6 !important; background-color: #f8f9fa !important; outline: none !important; }
    .seamless-input.valid.modified:focus, .seamless-input.modified.valid:focus { border-color: #dee2e6 !important; background-color: #f8f9fa !important; outline: none !important; }
    .seamless-checkbox { cursor: pointer; width: 1.2em; height: 1.2em; }
</style>

@code {
    // Enum for Priority
    public enum Priority
    {
        Low,
        Medium,
        High
    }

    // Model with validation
    public class ValidatedProduct
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "Name is required")]
        [StringLength(100, ErrorMessage = "Name cannot exceed 100 characters")]
        public string Name { get; set; } = string.Empty;

        [Required]
        [Range(0.01, 999999.99, ErrorMessage = "Price must be between 0.01 and 999999.99")]
        public decimal Price { get; set; }

        [Required]
        [Range(0, int.MaxValue, ErrorMessage = "Stock cannot be negative")]
        public int Stock { get; set; }

        [Required(ErrorMessage = "Location is required")]
        public string Location { get; set; } = "LA";

        public bool IsInStock { get; set; } = true;

        [Required(ErrorMessage = "Release date is required")]
        public DateOnly ReleaseDate { get; set; } = DateOnly.FromDateTime(DateTime.Now);

        [Required(ErrorMessage = "Priority is required")]
        public Priority Priority { get; set; } = Priority.Medium;

        [StringLength(500, ErrorMessage = "Description cannot exceed 500 characters")]
        public string? Description { get; set; }
    }

    // Data set
    private List<ValidatedProduct> products = new()
    {
        new() { Id = 1, Name = "Keyboard", Price = 29.99m, Stock = 50, Location = "LA", IsInStock = true, ReleaseDate = new DateOnly(2024, 1, 15), Priority = Priority.High, Description = "Mechanical gaming keyboard with RGB" },
        new() { Id = 2, Name = "Mouse", Price = 19.99m, Stock = 120, Location = "NYC", IsInStock = true, ReleaseDate = new DateOnly(2024, 2, 20), Priority = Priority.Medium, Description = "Wireless optical mouse" },
        new() { Id = 3, Name = "Monitor", Price = 199.99m, Stock = 15, Location = "Wash DC", IsInStock = false, ReleaseDate = new DateOnly(2023, 11, 5), Priority = Priority.Low, Description = "27-inch 4K display" },
        new() { Id = 4, Name = "USB Hub", Price = 14.99m, Stock = 75, Location = "LA", IsInStock = true, ReleaseDate = new DateOnly(2024, 3, 10), Priority = Priority.Medium, Description = "7-port USB 3.0 hub" },
    };

    private bool hasUnsavedChanges = false;
    private DateTime? lastSaveTime;
    private int secondsUntilSave = 5;
    private System.Threading.Timer? autoSaveTimer;
    private System.Threading.Timer? countdownTimer;

    protected override void OnInitialized()
    {
        // Timer that checks every second for countdown display
        countdownTimer = new System.Threading.Timer(async _ =>
        {
            if (hasUnsavedChanges && secondsUntilSave > 0)
            {
                secondsUntilSave--;
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void OnFieldChanged(ValidatedProduct product, object? value)
    {
        if (!hasUnsavedChanges)
        {
            hasUnsavedChanges = true;
            secondsUntilSave = 5;
            
            // Schedule auto-save after 5 seconds
            autoSaveTimer?.Dispose();
            autoSaveTimer = new System.Threading.Timer(async _ =>
            {
                await AutoSave();
            }, null, TimeSpan.FromSeconds(5), Timeout.InfiniteTimeSpan);
        }
        else
        {
            // Reset the timer if already running
            secondsUntilSave = 5;
            autoSaveTimer?.Dispose();
            autoSaveTimer = new System.Threading.Timer(async _ =>
            {
                await AutoSave();
            }, null, TimeSpan.FromSeconds(5), Timeout.InfiniteTimeSpan);
        }
    }

    private async Task AutoSave()
    {
        // Validate all products
        bool allValid = true;
        foreach (var product in products)
        {
            var editContext = new EditContext(product);
            if (!editContext.Validate())
            {
                allValid = false;
                break;
            }
        }

        if (allValid)
        {
            // Here you would normally save to a database
            // For now, we just mark as saved
            hasUnsavedChanges = false;
            lastSaveTime = DateTime.Now;
            secondsUntilSave = 5;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        autoSaveTimer?.Dispose();
        countdownTimer?.Dispose();
    }
}
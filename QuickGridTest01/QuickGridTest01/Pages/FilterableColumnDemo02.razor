@page "/filterable-column-demo-2"
@using QuickGridTest01.Filterable
@using Microsoft.AspNetCore.Components.QuickGrid

<PageTitle>Filterable Column Demo 02</PageTitle>

<h3>FilterableGrid + FilterableColumn</h3>
<p>This demo uses the reusable filterable components (cascading grid + per-column header filters). External toolbar drives each column's filter UI.</p>

<div class="demo-section">
    <h4>Employees</h4>

    <div class="filter-toolbar">
        @if (_employeeGrid is not null && _employeeGrid.Columns?.Count > 0)
        {
            foreach (var col in _employeeGrid.Columns)
            {
                <div class="ft-item @(col.HasActiveFilter ? "active" : "")">
                    @col.BuildFilterToolbar
                </div>
            }
            <div class="ft-actions">
                <button class="btn btn-sm btn-primary" @onclick="ApplyEmployeeFilters">Apply</button>
                <button class="btn btn-sm btn-secondary" @onclick="ClearEmployeeFilters">Clear All</button>
            </div>
        }
    </div>

    <FilterableGrid TGridItem="Employee" Items="@Employees" Class="table table-striped" @ref="_employeeGrid">
        <FilterableColumn TGridItem="Employee" TValue="int" Property="@(e => e.Id)" Title="ID" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.FirstName)" Title="First Name" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.LastName)" Title="Last Name" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Department)" Title="Department" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Email)" Title="Email" />
        <FilterableColumn TGridItem="Employee" TValue="int" Property="@(e => e.Salary)" Title="Salary" Format="C0" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="DateTime" Property="@(e => e.HireDate)" Title="Hire Date" Format="yyyy-MM-dd" Sortable="true" />
        <FilterableColumn TGridItem="Employee" TValue="bool" Property="@(e => e.IsActive)" Title="Active" />
    </FilterableGrid>
</div>

<div class="demo-section">
    <h4>Products</h4>

    <div class="filter-toolbar">
        @if (_productGrid is not null && _productGrid.Columns?.Count > 0)
        {
            foreach (var col in _productGrid.Columns)
            {
                <div class="ft-item @(col.HasActiveFilter ? "active" : "")">
                    @col.BuildFilterToolbar
                </div>
            }
            <div class="ft-actions">
                <button class="btn btn-sm btn-primary" @onclick="ApplyProductFilters">Apply</button>
                <button class="btn btn-sm btn-secondary" @onclick="ClearProductFilters">Clear All</button>
            </div>
        }
    </div>

    <FilterableGrid TGridItem="Product" Items="@Products" Class="table table-striped" @ref="_productGrid">
        <FilterableColumn TGridItem="Product" TValue="int" Property="@(p => p.Id)" Title="ID" Sortable="true" />
        <FilterableColumn TGridItem="Product" TValue="string" Property="@(p => p.Name)" Title="Product" Sortable="true" />
        <FilterableColumn TGridItem="Product" TValue="string" Property="@(p => p.Category)" Title="Category" Sortable="true" />
        <FilterableColumn TGridItem="Product" TValue="decimal" Property="@(p => p.Price)" Title="Price" Format="C2" Sortable="true" />
        <FilterableColumn TGridItem="Product" TValue="int" Property="@(p => p.Stock)" Title="Stock" Sortable="true" />
        <FilterableColumn TGridItem="Product" TValue="double" Property="@(p => p.Rating)" Title="Rating" />
    </FilterableGrid>
</div>

<style>
.filter-toolbar { display:flex; flex-wrap:wrap; gap:.75rem; margin-bottom:.75rem; align-items:flex-end; }
.filter-toolbar .ft-item { display:flex; align-items:flex-end; gap:.5rem; }
.ft-inline { display:flex; gap:.5rem; align-items:flex-end; }
.ft-label { font-weight:600; font-size:.8rem; }
.ft-operator, .filter-value { padding:.3rem .4rem; font-size:.8rem; border:1px solid #ced4da; border-radius:.25rem; }
.filter-toolbar .ft-actions { margin-left:auto; display:flex; gap:.5rem; }
</style>

@code {
    private IQueryable<Employee> Employees = default!;
    private IQueryable<Product> Products = default!;

    private FilterableGrid<Employee>? _employeeGrid;
    private FilterableGrid<Product>? _productGrid;

    private bool _rerenderPending;

    protected override void OnInitialized()
    {
        Employees = new List<Employee>
        {
            new() { Id = 1, FirstName = "John", LastName = "Smith", Department = "Engineering", Email = "john.smith@company.com", Salary = 95000, HireDate = new DateTime(2020, 3, 15), IsActive = true },
            new() { Id = 2, FirstName = "Sarah", LastName = "Johnson", Department = "Marketing", Email = "sarah.j@company.com", Salary = 78000, HireDate = new DateTime(2021, 7, 22), IsActive = true },
            new() { Id = 3, FirstName = "Michael", LastName = "Brown", Department = "Engineering", Email = "m.brown@company.com", Salary = 103000, HireDate = new DateTime(2019, 1, 10), IsActive = true },
            new() { Id = 4, FirstName = "Emily", LastName = "Davis", Department = "HR", Email = "emily.davis@company.com", Salary = 72000, HireDate = new DateTime(2022, 4, 5), IsActive = false },
            new() { Id = 5, FirstName = "David", LastName = "Wilson", Department = "Sales", Email = "d.wilson@company.com", Salary = 85000, HireDate = new DateTime(2020, 11, 30), IsActive = true },
            new() { Id = 6, FirstName = "Jennifer", LastName = "Martinez", Department = "Engineering", Email = "j.martinez@company.com", Salary = 98000, HireDate = new DateTime(2021, 2, 14), IsActive = true },
            new() { Id = 7, FirstName = "Robert", LastName = "Garcia", Department = "Finance", Email = "robert.g@company.com", Salary = 91000, HireDate = new DateTime(2018, 9, 8), IsActive = true },
            new() { Id = 8, FirstName = "Lisa", LastName = "Anderson", Department = "Marketing", Email = "lisa.a@company.com", Salary = 76000, HireDate = new DateTime(2023, 1, 20), IsActive = true },
            new() { Id = 9, FirstName = "James", LastName = "Taylor", Department = "Sales", Email = "james.t@company.com", Salary = 83000, HireDate = new DateTime(2019, 6, 12), IsActive = false },
            new() { Id = 10, FirstName = "Amanda", LastName = "White", Department = "Engineering", Email = "amanda.w@company.com", Salary = 105000, HireDate = new DateTime(2017, 3, 25), IsActive = true }
        }.AsQueryable();

        Products = new List<Product>
        {
            new() { Id = 1, Name = "Laptop Pro", Category = "Electronics", Price = 1299.99m, Stock = 45, Rating = 4.5 },
            new() { Id = 2, Name = "Office Chair", Category = "Furniture", Price = 399.99m, Stock = 23, Rating = 4.2 },
            new() { Id = 3, Name = "Wireless Mouse", Category = "Electronics", Price = 49.99m, Stock = 150, Rating = 4.7 },
            new() { Id = 4, Name = "Desk Lamp", Category = "Furniture", Price = 79.99m, Stock = 0, Rating = 4.0 },
            new() { Id = 5, Name = "USB-C Hub", Category = "Electronics", Price = 89.99m, Stock = 67, Rating = 4.6 },
            new() { Id = 6, Name = "Monitor Stand", Category = "Furniture", Price = 149.99m, Stock = 31, Rating = 4.3 },
            new() { Id = 7, Name = "Mechanical Keyboard", Category = "Electronics", Price = 179.99m, Stock = 58, Rating = 4.8 }
        }.AsQueryable();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_rerenderPending)
        {
            _rerenderPending = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task ApplyEmployeeFilters() => _employeeGrid?.OnFilterChangedAsync() ?? Task.CompletedTask;
    private Task ClearEmployeeFilters() => _employeeGrid?.ClearAllFiltersAsync() ?? Task.CompletedTask;

    private Task ApplyProductFilters() => _productGrid?.OnFilterChangedAsync() ?? Task.CompletedTask;
    private Task ClearProductFilters() => _productGrid?.ClearAllFiltersAsync() ?? Task.CompletedTask;

    public class Employee
    {
        public int Id { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public int Salary { get; set; }
        public DateTime HireDate { get; set; }
        public bool IsActive { get; set; }
    }

    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public double Rating { get; set; }
    }
}

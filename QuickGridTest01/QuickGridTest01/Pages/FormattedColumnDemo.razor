@page "/formatted-column-demo"
@using Microsoft.AspNetCore.Components.QuickGrid
@using QuickGridTest01.FormattedValue.Component
@using QuickGridTest01.FormattedValue.Formatters
@using QuickGridTest01.FormattedValue.Demo.Models
@using System.Globalization

<PageTitle>Formatted Value Column - Demo</PageTitle>

<div class="qg-container">

    <header class="qg-page-header">
        <h1 class="qg-page-title">Formatted Value Column Demo</h1>
        <p class="qg-page-subtitle">Comprehensive formatting examples</p>
    </header>

    <div class="demo-description">
        <h3>Why a FormattedValueColumn?</h3>
        <p><strong>Problem:</strong> Repeating <code>ToString()</code>, format strings, and culture switches inline in grids scatters logic and creates inconsistency. Complex formats (durations, file sizes, relative dates) add noise to page markup.</p>
        <p><strong>Solution:</strong> <code>FormattedValueColumn&lt;TItem,TValue&gt;</code> accepts a <code>Formatter</code> delegate and optional <code>CultureName</code>. Consumers declare intent while the component handles extraction, culture, and rendering.</p>
        <p><strong>Runtime Switching:</strong> Dropâ€‘downs change culture, date/time style, and numeric style. Columns recompute formatting without duplicating logic.</p>
    </div>


    <div class="culture-selector">
        <label>
            <span class="selector-label">Culture</span>
            <select @bind="SelectedCulture" @bind:after="OnCultureChanged">
                <option value="en-US">English (United States)</option>
                <option value="en-GB">English (United Kingdom)</option>
                <option value="de-DE">German (Germany)</option>
                <option value="fr-FR">French (France)</option>
                <option value="ja-JP">Japanese (Japan)</option>
                <option value="es-ES">Spanish (Spain)</option>
            </select>
        </label>
        <label>
            <span class="selector-label">Date/Time</span>
            <select @bind="SelectedDateTimeFormat" @bind:after="OnDateTimeFormatChanged">
                <option value="short">Short Date</option>
                <option value="long">Long Date</option>
                <option value="general">Date &amp; Time (General)</option>
                <option value="iso">ISO Date</option>
                <option value="relative">Relative Date</option>
                <option value="time12">Time (12h)</option>
                <option value="time24">Time (24h)</option>
            </select>
        </label>
        <label>
            <span class="selector-label">Numeric</span>
            <select @bind="SelectedNumericFormat" @bind:after="OnNumericFormatChanged">
                <option value="number">Number (N)</option>
                <option value="fixed">Fixed (F)</option>
                <option value="scientific">Scientific (E)</option>
                <option value="compact">Compact (K/M/B)</option>
            </select>
        </label>
        <span class="culture-info">Current: @CurrentCulture.DisplayName | DateTime: @SelectedDateTimeFormat | Numeric: @SelectedNumericFormat</span>
    </div>

    <!-- Financial Transactions -->
    <section class="demo-section">
        <div class="section-header">
            <h2>Financial Transactions</h2>
            <p>Currency formatting with accounting style for negative values and selectable date format.</p>
        </div>
        <QuickGrid Items="@Transactions" Class="demo-grid" @key="@GridKey">
            <FormattedValueColumn Property="@(t => t.Date)" Formatter="@DateTimeSelectionFormatter" CultureName="@SelectedCulture" Title="Date" />
            <PropertyColumn Property="@(t => t.Description)" Title="Description" />
            <PropertyColumn Property="@(t => t.Type)" Title="Type" />
            <FormattedValueColumn Property="@(t => t.Amount)" Formatter="@CurrencyFormatter2" CultureName="@SelectedCulture" Title="Amount" />
            <FormattedValueColumn Property="@(t => t.Balance)" Formatter="@CurrencyAccountingFormatter" CultureName="@SelectedCulture" Title="Balance" />
        </QuickGrid>
    </section>

    <!-- Product Inventory -->
    <section class="demo-section">
        <div class="section-header">
            <h2>Product Inventory</h2>
            <p>Mixed formats with selectable date and numeric representation.</p>
        </div>
        <QuickGrid Items="@Products" Class="demo-grid" @key="@GridKey">
            <PropertyColumn Property="@(p => p.Name)" Title="Product" />
            <FormattedValueColumn Property="@(p => p.Price)" Formatter="@CurrencyFormatter2" CultureName="@SelectedCulture" Title="Price" />
            <FormattedValueColumn Property="@(p => p.DiscountedPrice)" Formatter="@CurrencyFormatter2" CultureName="@SelectedCulture" Title="Discounted" />
            <FormattedValueColumn Property="@(p => p.DiscountPercent)" Formatter="@PercentageFormatter0" CultureName="@SelectedCulture" Title="Discount" />
            <FormattedValueColumn Property="@(p => p.Stock)" Formatter="@NumericSelectionFormatter0" CultureName="@SelectedCulture" Title="Stock" />
            <FormattedValueColumn Property="@(p => p.Weight)" Formatter="@NumericSelectionFormatter1" CultureName="@SelectedCulture" Title="Weight (g)" />
            <FormattedValueColumn Property="@(p => p.SizeBytes)" Formatter="@FileSizeFormatter" CultureName="@SelectedCulture" Title="Package Size" />
            <FormattedValueColumn Property="@(p => p.LastRestocked)" Formatter="@DateTimeSelectionFormatter" CultureName="@SelectedCulture" Title="Last Restocked" />
        </QuickGrid>
    </section>

    <!-- Employee Directory -->
    <section class="demo-section">
        <div class="section-header">
            <h2>Employee Directory</h2>
            <p>Date formats and phone numbers with selectable date/time style.</p>
        </div>
        <QuickGrid Items="@Employees" Class="demo-grid" @key="@GridKey">
            <PropertyColumn Property="@(e => e.FullName)" Title="Name" />
            <PropertyColumn Property="@(e => e.Email)" Title="Email" />
            <FormattedValueColumn Property="@(e => e.Phone)" Formatter="@PhoneNumberFormatter" CultureName="@SelectedCulture" Title="Phone" />
            <FormattedValueColumn Property="@(e => e.HireDate)" Formatter="@DateTimeSelectionFormatter" CultureName="@SelectedCulture" Title="Hire Date" />
            <FormattedValueColumn Property="@(e => e.Salary)" Formatter="@CurrencyFormatter0" CultureName="@SelectedCulture" Title="Salary" />
            <FormattedValueColumn Property="@(e => e.IsActive)" Formatter="@YesNoFormatter" CultureName="@SelectedCulture" Title="Active" />
        </QuickGrid>
    </section>

    <!-- Performance Metrics -->
    <section class="demo-section">
        <div class="section-header">
            <h2>Performance Metrics</h2>
            <p>Calculated properties with selectable numeric representation.</p>
        </div>
        <QuickGrid Items="@Metrics" Class="demo-grid" @key="@GridKey">
            <PropertyColumn Property="@(m => m.MetricName)" Title="Metric" />
            <FormattedValueColumn Property="@(m => m.CurrentValue)" Formatter="@NumericSelectionFormatter1" CultureName="@SelectedCulture" Title="Current" />
            <FormattedValueColumn Property="@(m => m.TargetValue)" Formatter="@NumericSelectionFormatter1" CultureName="@SelectedCulture" Title="Target" />
            <FormattedValueColumn Property="@(m => m.PercentOfTarget)" Formatter="@PercentageFormatter1" CultureName="@SelectedCulture" Title="% of Target" />
            <FormattedValueColumn Property="@(m => m.ChangePercent)" Formatter="@PercentageFormatter1" CultureName="@SelectedCulture" Title="Change %" />
        </QuickGrid>
    </section>

    <!-- System Logs -->
    <section class="demo-section">
        <div class="section-header">
            <h2>System Logs</h2>
            <p>Timestamps and durations with selectable date/time style.</p>
        </div>
        <QuickGrid Items="@Logs" Class="demo-grid" @key="@GridKey">
            <FormattedValueColumn Property="@(l => l.Timestamp)" Formatter="@DateTimeSelectionFormatter" CultureName="@SelectedCulture" Title="Timestamp" />
            <PropertyColumn Property="@(l => l.Level)" Title="Level" />
            <PropertyColumn Property="@(l => l.Source)" Title="Source" />
            <PropertyColumn Property="@(l => l.Message)" Title="Message" />
            <FormattedValueColumn Property="@(l => l.Duration)" Formatter="@HumanDurationFormatter" CultureName="@SelectedCulture" Title="Duration" />
            <FormattedValueColumn Property="@(l => l.MemoryBytes)" Formatter="@FileSizeFormatter2" CultureName="@SelectedCulture" Title="Memory" />
        </QuickGrid>
    </section>

    <!-- Documentation -->
    <section class="demo-documentation">
        <h2>About This Demo</h2>
        <div class="doc-grid">
            <div class="doc-section">
                <h3>Key Features</h3>
                <ul>
                    <li><strong>30+ Formatters:</strong> Currency, numeric, date/time, specialized</li>
                    <li><strong>Culture / Date / Numeric Switching:</strong> Runtime selection</li>
                    <li><strong>Type-Safe:</strong> Property expressions compiled once</li>
                    <li><strong>No Stale State:</strong> Formatters created per render using current culture</li>
                    <li><strong>Sorting:</strong> Enabled via expression metadata</li>
                    <li><strong>Extensible:</strong> Add new delegates easily</li>
                </ul>
            </div>
            <div class="doc-section">
                <h3>Architecture</h3>
                <ul>
                    <li><strong>Layer 1:</strong> Formatter helpers</li>
                    <li><strong>Layer 2:</strong> Formatter library</li>
                    <li><strong>Layer 3:</strong> Column component</li>
                    <li><strong>Layer 4:</strong> Demo + switching UI</li>
                </ul>
            </div>
            <div class="doc-section">
                <h3>Usage</h3>
                <pre><code>&lt;FormattedValueColumn
    Property="@@(m =&gt; m.CurrentValue)"
    Formatter="@@NumericSelectionFormatter1"
    CultureName="@@SelectedCulture"
    Title="Current" /&gt;</code></pre>
                <p><em>Select culture, date/time, and numeric style to re-render formatted cells.</em></p>
            </div>
            <div class="doc-section">
                <h3>Performance</h3>
                <ul>
                    <li><strong>Compiled Accessor:</strong> Fast property reads</li>
                    <li><strong>Delegate Switch:</strong> Lightweight per render</li>
                    <li><strong>Low Allocation:</strong> Only final string output</li>
                    <li><strong>Full Re-render:</strong> Triggered by selection changes</li>
                </ul>
            </div>
        </div>
    </section>
</div>

@code {
    private string SelectedCulture { get; set; } = "en-US";
    private string SelectedDateTimeFormat { get; set; } = "short";
    private string SelectedNumericFormat { get; set; } = "number";
    private CultureInfo CurrentCulture { get; set; } = CultureInfo.GetCultureInfo("en-US");

    private IQueryable<Transaction> Transactions { get; set; } = null!;
    private IQueryable<Product> Products { get; set; } = null!;
    private IQueryable<Employee> Employees { get; set; } = null!;
    private IQueryable<PerformanceMetric> Metrics { get; set; } = null!;
    private IQueryable<LogEntry> Logs { get; set; } = null!;

    private string GridKey => $"{SelectedCulture}-{SelectedDateTimeFormat}-{SelectedNumericFormat}";

    private Func<object?, string> CurrencyFormatter0 => CurrencyFormatters.Currency(0);
    private Func<object?, string> CurrencyFormatter2 => CurrencyFormatters.Currency(2);
    private Func<object?, string> CurrencyAccountingFormatter => CurrencyFormatters.CurrencyAccounting(2);
    private Func<object?, string> PercentageFormatter0 => NumericFormatters.Percentage(0);
    private Func<object?, string> PercentageFormatter1 => NumericFormatters.Percentage(1);
    private Func<object?, string> FileSizeFormatter => SpecializedFormatters.FileSize(1);
    private Func<object?, string> FileSizeFormatter2 => SpecializedFormatters.FileSize(2);
    private Func<object?, string> HumanDurationFormatter => DateTimeFormatters.HumanDuration();
    private Func<object?, string> PhoneNumberFormatter => SpecializedFormatters.PhoneNumberUs();
    private Func<object?, string> YesNoFormatter => SpecializedFormatters.YesNo();

    private Func<object?, string> NumericSelectionFormatter0 => SelectedNumericFormat switch
    {
        "number" => NumericFormatters.Number(0),
        "fixed" => NumericFormatters.FixedPoint(0),
        "scientific" => NumericFormatters.Scientific(2),
        "compact" => NumericFormatters.CompactNumber(1),
        _ => NumericFormatters.Number(0)
    };
    private Func<object?, string> NumericSelectionFormatter1 => SelectedNumericFormat switch
    {
        "number" => NumericFormatters.Number(1),
        "fixed" => NumericFormatters.FixedPoint(1),
        "scientific" => NumericFormatters.Scientific(2),
        "compact" => NumericFormatters.CompactNumber(1),
        _ => NumericFormatters.Number(1)
    };

    private Func<object?, string> DateTimeSelectionFormatter => SelectedDateTimeFormat switch
    {
        "short" => DateTimeFormatters.ShortDate(),
        "long" => DateTimeFormatters.LongDate(),
        "general" => DateTimeFormatters.DateTime(),
        "iso" => DateTimeFormatters.IsoDate(),
        "relative" => DateTimeFormatters.RelativeDate(),
        "time12" => DateTimeFormatters.Time12Hour(),
        "time24" => DateTimeFormatters.Time24Hour(),
        _ => DateTimeFormatters.ShortDate()
    };

    protected override void OnInitialized()
    {
        ApplyCulture("en-US");
        LoadSampleData();
    }

    private void OnCultureChanged()
    {
        ApplyCulture(SelectedCulture);
        StateHasChanged();
    }

    private void OnDateTimeFormatChanged() => StateHasChanged();
    private void OnNumericFormatChanged() => StateHasChanged();

    private void ApplyCulture(string cultureName)
    {
        CurrentCulture = CultureInfo.GetCultureInfo(cultureName);
        CultureInfo.CurrentCulture = CurrentCulture;
        CultureInfo.CurrentUICulture = CurrentCulture;
        CultureInfo.DefaultThreadCurrentCulture = CurrentCulture;
        CultureInfo.DefaultThreadCurrentUICulture = CurrentCulture;
    }

    private void LoadSampleData()
    {
        Transactions = new[]
        {
            new Transaction { Id = 1, Date = DateTime.Now.AddDays(-5), Description = "Initial Deposit", Amount = 5000m, Balance = 5000m, Type = "Deposit" },
            new Transaction { Id = 2, Date = DateTime.Now.AddDays(-4), Description = "Rent Payment", Amount = -1500m, Balance = 3500m, Type = "Withdrawal" },
            new Transaction { Id = 3, Date = DateTime.Now.AddDays(-3), Description = "Salary", Amount = 3500m, Balance = 7000m, Type = "Deposit" },
            new Transaction { Id = 4, Date = DateTime.Now.AddDays(-2), Description = "Grocery Shopping", Amount = -250.75m, Balance = 6749.25m, Type = "Debit" },
            new Transaction { Id = 5, Date = DateTime.Now.AddDays(-1), Description = "Utilities", Amount = -175.50m, Balance = 6573.75m, Type = "Debit" },
            new Transaction { Id = 6, Date = DateTime.Now, Description = "Freelance Payment", Amount = 800m, Balance = 7373.75m, Type= "Deposit" }
        }.AsQueryable();

        Products = new[]
        {
            new Product { Id = 1, Name = "Laptop Pro 15\"", Price = 1299.99m, Stock = 45, DiscountPercent = 15, Weight = 1800.5, SizeBytes = 524288000, LastRestocked = DateTime.Now.AddDays(-2) },
            new Product { Id = 2, Name = "Wireless Mouse", Price = 29.99m, Stock = 234, DiscountPercent = 0, Weight = 95.2, SizeBytes = 1048576, LastRestocked = DateTime.Now.AddDays(-5) },
            new Product { Id = 3, Name = "USB-C Hub", Price = 49.99m, Stock = 89, DiscountPercent = 20, Weight = 120.8, SizeBytes = 2097152, LastRestocked = DateTime.Now.AddDays(-1) },
            new Product { Id = 4, Name = "4K Monitor", Price = 399.99m, Stock = 12, DiscountPercent = 10, Weight = 5200.0, SizeBytes = 10485760, LastRestocked = DateTime.Now.AddDays(-7) },
            new Product { Id = 5, Name = "Mechanical Keyboard", Price = 129.99m, Stock = 67, DiscountPercent = 5, Weight = 980.3, SizeBytes = 3145728, LastRestocked = DateTime.Now.AddDays(-3) }
        }.AsQueryable();

        Employees = new[]
        {
            new Employee { Id = 1, FirstName = "Alice", LastName = "Johnson", Email = "alice.johnson@example.com", Phone = "5551234567", HireDate = new DateTime(2020, 3, 15), Salary = 75000m, IsActive = true },
            new Employee { Id = 2, FirstName = "Bob", LastName = "Smith", Email = "bob.smith@example.com", Phone = "5559876543", HireDate = new DateTime(2019, 7, 22), Salary = 82000m, IsActive = true },
            new Employee { Id = 3, FirstName = "Carol", LastName = "Williams", Email = "carol.williams@example.com", Phone = "5555551212", HireDate = new DateTime(2021, 1, 10), Salary = 68000m, IsActive = true },
            new Employee { Id = 4, FirstName = "David", LastName = "Brown", Email = "david.brown@example.com", Phone = "5554443333", HireDate = new DateTime(2018, 11, 5), TerminationDate = new DateTime(2023, 6, 30), Salary = 0m, IsActive = false },
            new Employee { Id = 5, FirstName = "Eve", LastName = "Davis", Email = "eve.davis@example.com", Phone = "5552223344", HireDate = new DateTime(2022, 4, 18), Salary = 71000m, IsActive = true }
        }.AsQueryable();

        Metrics = new[]
        {
            new PerformanceMetric { MetricName = "Revenue", CurrentValue = 285000m, TargetValue = 250000m, PreviousValue = 265000m },
            new PerformanceMetric { MetricName = "Customer Acquisition", CurrentValue = 450m, TargetValue = 500m, PreviousValue = 420m },
            new PerformanceMetric { MetricName = "Conversion Rate", CurrentValue = 3.8m, TargetValue = 4.0m, PreviousValue = 3.5m },
            new PerformanceMetric { MetricName = "Churn Rate", CurrentValue = 2.1m, TargetValue = 3.0m, PreviousValue = 2.5m },
            new PerformanceMetric { MetricName = "Average Order Value", CurrentValue = 127.50m, TargetValue = 120.00m, PreviousValue = 115.00m }
        }.AsQueryable();

        Logs = new[]
        {
            new LogEntry { Id = 1, Timestamp = DateTime.Now.AddMinutes(-30), Level = "INFO", Source = "WebServer", Message = "Application started successfully", Duration = 1250.5, MemoryBytes = 157286400 },
            new LogEntry { Id = 2, Timestamp = DateTime.Now.AddMinutes(-25), Level = "INFO", Source = "Database", Message = "Connection pool initialized", Duration = 850.2, MemoryBytes = 104857600 },
            new LogEntry { Id = 3, Timestamp = DateTime.Now.AddMinutes(-20), Level = "WARNING", Source = "Cache", Message = "Cache miss rate exceeding threshold", Duration = 50.8, MemoryBytes = 524288000 },
            new LogEntry { Id = 4, Timestamp = DateTime.Now.AddMinutes(-15), Level = "ERROR", Source = "API", Message = "External service timeout", Duration = 30250.0, MemoryBytes = 209715200 },
            new LogEntry { Id = 5, Timestamp = DateTime.Now.AddMinutes(-10), Level = "INFO", Source = "BackgroundJob", Message = "Daily backup completed", Duration = 125500.0, MemoryBytes = 1073741824 },
            new LogEntry { Id = 6, Timestamp = DateTime.Now.AddMinutes(-5), Level = "INFO", Source = "WebServer", Message = "Request processed successfully", Duration = 125.3, MemoryBytes = 83886080 }
        }.AsQueryable();
    }
}

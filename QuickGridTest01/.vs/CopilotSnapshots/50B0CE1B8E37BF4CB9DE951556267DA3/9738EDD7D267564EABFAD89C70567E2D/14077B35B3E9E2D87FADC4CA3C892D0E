@page "/editable-column-demo"
@using Microsoft.AspNetCore.Components.QuickGrid
@using QuickGridTest01.CustomColumns
@using System.ComponentModel.DataAnnotations

<PageTitle>Editable Column Demo</PageTitle>

<h3>Editable Column (Inline Editing via Custom Column)</h3>

<p>
    This demo refactors the previous ad hoc EditForm-per-cell approach to use the reusable <code>EditableColumn</code>.
    Columns render inline inputs with DataAnnotations + custom validators, debounced validation, and auto-commit.
</p>

<div class="demo-section">
    <h4>Employee Editor (Inline)</h4>
    <p class="info-text">
        Inline editors using <code>EditableColumn</code>. Validation combines DataAnnotations and explicit validators. Auto-commit on valid change.
    </p>

    <QuickGrid Items="@employees" Class="demo-grid">
        <PropertyColumn Property="@(e => e.Id)" Title="ID" />

        <EditableColumn TGridItem="Employee" TValue="string" Property="@(e => e.FirstName)" Title="First Name" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="250" Validators="@FirstLastNameValidators" OnValueChanged="@OnEmployeeValueChanged" />
        <EditableColumn TGridItem="Employee" TValue="string" Property="@(e => e.LastName)" Title="Last Name" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="250" Validators="@FirstLastNameValidators" OnValueChanged="@OnEmployeeValueChanged" />
        <EditableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Email)" Title="Email" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="300" Validators="@EmailValidators" OnValueChanged="@OnEmployeeValueChanged" />
        <EditableColumn TGridItem="Employee" TValue="string" Property="@(e => e.Department)" Title="Department" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="300" Validators="@DepartmentValidators" OnValueChanged="@OnEmployeeValueChanged" />
        <EditableColumn TGridItem="Employee" TValue="int" Property="@(e => e.Salary)" Title="Salary" Inline="true" UseDataAnnotations="true" InputType="number" DebounceMilliseconds="300" Validators="@SalaryValidators" OnValueChanged="@OnEmployeeValueChanged" />
        <EditableColumn TGridItem="Employee" TValue="DateTime" Property="@(e => e.HireDate)" Title="Hire Date" Inline="true" UseDataAnnotations="true" InputType="date" DebounceMilliseconds="300" Validators="@HireDateValidators" OnValueChanged="@OnEmployeeValueChanged" />
    </QuickGrid>

    @if (_changeLog.Any())
    {
        <div class="change-log">
            <h5>Recent Changes:</h5>
            <div class="log-entries">
                @foreach (var entry in _changeLog.TakeLast(8).Reverse())
                {
                    <div class="log-entry">@entry</div>
                }
            </div>
        </div>
    }
</div>

<div class="demo-section">
    <h4>Product Inventory Editor (Inline)</h4>
    <p class="info-text">
        Products use the same approach. Debounced validation and auto-commit on valid modifications.
    </p>

    <QuickGrid Items="@products" Class="demo-grid">
        <PropertyColumn Property="@(p => p.Id)" Title="ID" />

        <EditableColumn TGridItem="Product" TValue="string" Property="@(p => p.Name)" Title="Product Name" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="250" Validators="@ProductNameValidators" OnValueChanged="@OnProductValueChanged" />
        <EditableColumn TGridItem="Product" TValue="string" Property="@(p => p.SKU)" Title="SKU" Inline="true" UseDataAnnotations="true" DebounceMilliseconds="300" Validators="@SkuValidators" OnValueChanged="@OnProductValueChanged" />
        <EditableColumn TGridItem="Product" TValue="decimal" Property="@(p => p.Price)" Title="Price" Inline="true" UseDataAnnotations="true" InputType="number" DebounceMilliseconds="300" Validators="@PriceValidators" OnValueChanged="@OnProductValueChanged" />
        <EditableColumn TGridItem="Product" TValue="int" Property="@(p => p.Stock)" Title="Stock" Inline="true" UseDataAnnotations="true" InputType="number" DebounceMilliseconds="300" Validators="@StockValidators" OnValueChanged="@OnProductValueChanged" />
        <EditableColumn TGridItem="Product" TValue="double" Property="@(p => p.Rating)" Title="Rating" Inline="true" UseDataAnnotations="true" InputType="number" DebounceMilliseconds="300" Validators="@RatingValidators" OnValueChanged="@OnProductValueChanged" />

        <TemplateColumn Title="Status" Context="context">
            <span class="stock-badge stock-@GetStockLevel(context.Stock)">@GetStockText(context.Stock)</span>
        </TemplateColumn>
    </QuickGrid>
</div>

<div class="demo-section">
    <h4>Validation Rules Summary</h4>
    <div class="validation-rules">
        <div class="rule-group">
            <h5>Employee Validations:</h5>
            <ul>
                <li><strong>First Name:</strong> Required, 2-50 characters</li>
                <li><strong>Last Name:</strong> Required, 2-50 characters</li>
                <li><strong>Email:</strong> Required, valid email format</li>
                <li><strong>Department:</strong> Required, min 2 characters</li>
                <li><strong>Salary:</strong> Between $30,000 and $250,000</li>
                <li><strong>Hire Date:</strong> Must be in the past</li>
            </ul>
        </div>
        <div class="rule-group">
            <h5>Product Validations:</h5>
            <ul>
                <li><strong>Name:</strong> Required, 3-100 characters</li>
                <li><strong>SKU:</strong> Required, pattern: ABC-1234</li>
                <li><strong>Price:</strong> Positive, max $10,000</li>
                <li><strong>Stock:</strong> Non-negative, max 9,999</li>
                <li><strong>Rating:</strong> Between 0.0 and 5.0</li>
            </ul>
        </div>
    </div>
</div>

<style>
    .seamless-input { border: 1px solid transparent; background: transparent; box-shadow:none; outline:none; }
    .seamless-input:focus { border-color:#dee2e6 !important; background:#f8f9fa !important; }
    ::deep .editable-cell.inline-mode.invalid .seamless-input { border-color:#dc3545 !important; }
    ::deep .validation-error { font-size:11px; }
</style>

@code {
    private IQueryable<Employee> employees = default!;
    private IQueryable<Product> products = default!;
    private List<string> _changeLog = new();

    // Validator lists
    private static readonly List<IValidator<string>> FirstLastNameValidators = new() { new RequiredStringValidator(), new StringLengthValidator { MinLength = 2, MaxLength = 50 } };
    private static readonly List<IValidator<string>> EmailValidators = new() { new RequiredStringValidator(), new EmailValidator() };
    private static readonly List<IValidator<string>> DepartmentValidators = new() { new RequiredStringValidator(), new StringLengthValidator { MinLength = 2, MaxLength = 100 } };
    private static readonly List<IValidator<int>> SalaryValidators = new() { new RangeValidator<int> { Minimum = 30000, Maximum = 250000 } };
    private static readonly List<IValidator<DateTime>> HireDateValidators = new() { new PastDateValidator() };

    private static readonly List<IValidator<string>> ProductNameValidators = new() { new RequiredStringValidator(), new StringLengthValidator { MinLength = 3, MaxLength = 100 } };
    private static readonly List<IValidator<string>> SkuValidators = new() { new RequiredStringValidator(), new PatternValidator { Pattern = "^[A-Z]{3}-\\d{4}$", ErrorMessage = "Format ABC-1234" } };
    private static readonly List<IValidator<decimal>> PriceValidators = new() { new RangeValidator<decimal> { Minimum = 0.0m, Maximum = 10000m }, new PositiveNumberValidator<decimal>() };
    private static readonly List<IValidator<int>> StockValidators = new() { new RangeValidator<int> { Minimum = 0, Maximum = 9999 } };
    private static readonly List<IValidator<double>> RatingValidators = new() { new RangeValidator<double> { Minimum = 0.0, Maximum = 5.0 } };

    protected override void OnInitialized()
    {
        InitializeEmployeeData();
        InitializeProductData();
    }

    private void InitializeEmployeeData()
    {
        var employeeList = new List<Employee>
        {
            new() { Id = 1, FirstName = "John", LastName = "Smith", Email = "john.smith@company.com", Department = "Engineering", Salary = 95000, HireDate = new DateTime(2020, 3, 15) },
            new() { Id = 2, FirstName = "Sarah", LastName = "Johnson", Email = "sarah.j@company.com", Department = "Marketing", Salary = 78000, HireDate = new DateTime(2021, 7, 22) },
            new() { Id = 3, FirstName = "Michael", LastName = "Brown", Email = "m.brown@company.com", Department = "Engineering", Salary = 103000, HireDate = new DateTime(2019, 1, 10) },
            new() { Id = 4, FirstName = "Emily", LastName = "Davis", Email = "emily.davis@company.com", Department = "HR", Salary = 72000, HireDate = new DateTime(2022, 4, 5) },
            new() { Id = 5, FirstName = "David", LastName = "Wilson", Email = "d.wilson@company.com", Department = "Sales", Salary = 85000, HireDate = new DateTime(2020, 11, 30) },
        };
        employees = employeeList.AsQueryable();
    }

    private void InitializeProductData()
    {
        var productList = new List<Product>
        {
            new() { Id = 1, Name = "Laptop Pro", SKU = "LAP-1001", Price = 1299.99m, Stock = 45, Rating = 4.5 },
            new() { Id = 2, Name = "Office Chair", SKU = "CHR-2001", Price = 399.99m, Stock = 23, Rating = 4.2 },
            new() { Id = 3, Name = "Wireless Mouse", SKU = "MOU-3001", Price = 49.99m, Stock = 150, Rating = 4.7 },
            new() { Id = 4, Name = "Desk Lamp", SKU = "LMP-4001", Price = 79.99m, Stock = 0, Rating = 4.0 },
            new() { Id = 5, Name = "USB-C Hub", SKU = "HUB-5001", Price = 89.99m, Stock = 67, Rating = 4.6 },
        };
        products = productList.AsQueryable();
    }

    private Task OnEmployeeValueChanged(CellValueChangedArgs<Employee, object> args)
    {
        LogChange("Employee", args.Item.Id, args.PropertyName, args.OldValue, args.NewValue);
        return Task.CompletedTask;
    }

    private Task OnProductValueChanged(CellValueChangedArgs<Product, object> args)
    {
        LogChange("Product", args.Item.Id, args.PropertyName, args.OldValue, args.NewValue);
        return Task.CompletedTask;
    }

    private void LogChange(string entityType, int id, string property, object oldVal, object newVal)
    {
        var timestamp = DateTime.Now.ToString("HH:mm:ss");
        _changeLog.Add($"[{timestamp}] {entityType} #{id} {property} changed: '{oldVal}' → '{newVal}'");
        StateHasChanged();
    }

    public class Employee
    {
        public int Id { get; set; }
        [Required][StringLength(50, MinimumLength = 2)] public string FirstName { get; set; } = string.Empty;
        [Required][StringLength(50, MinimumLength = 2)] public string LastName { get; set; } = string.Empty;
        [Required][EmailAddress] public string Email { get; set; } = string.Empty;
        [Required][MinLength(2)] public string Department { get; set; } = string.Empty;
        [Range(30000, 250000)] public int Salary { get; set; }
        public DateTime HireDate { get; set; }
    }

    public class Product
    {
        public int Id { get; set; }
        [Required][StringLength(100, MinimumLength = 3)] public string Name { get; set; } = string.Empty;
        [Required][RegularExpression(@"^[A-Z]{3}-\d{4}$", ErrorMessage = "SKU must be in format: ABC-1234")] public string SKU { get; set; } = string.Empty;
        [Range(0.0, 10000)] public decimal Price { get; set; }
        [Range(0, 9999)] public int Stock { get; set; }
        [Range(0.0, 5.0)] public double Rating { get; set; }
    }

    private string GetStockLevel(int stock) => stock switch
    {
        0 => "out",
        < 25 => "low",
        < 100 => "medium",
        _ => "high"
    };

    private string GetStockText(int stock) => stock switch
    {
        0 => "Out of Stock",
        < 25 => $"Low ({stock})",
        _ => $"In Stock ({stock})"
    };
}
